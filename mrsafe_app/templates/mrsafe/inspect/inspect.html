{% extends 'base.html' %}

{% block title %}AI Safety Inspection{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">üõ°Ô∏è AI-Powered Safety Image Inspection</h2>

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if error_details and debug %}
        <div class="alert alert-warning">
            <strong>Error Details (Debug):</strong>
            <pre>{{ error_details }}</pre>
        </div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data" class="mb-4">
        {% csrf_token %}
        <div class="form-group">
            <label for="photo">Upload Safety Image (max 5MB):</label>
            <input type="file" name="photo" accept="image/*" class="form-control-file" required>
        </div>
        <button type="submit" class="btn btn-primary mt-2">üîç Analyze Image</button>
    </form>

    {% if photo_url %}
        <div class="mb-4 text-center">
            <h5>Uploaded Image Preview</h5>
            <img src="{{ photo_url }}" class="img-fluid rounded border shadow-sm" alt="Uploaded Image" style="max-width: 100%; height: auto;">
        </div>
    {% endif %}

    {% if result %}
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="card-title mb-0">üìã Inspection Report</h4>
                    <div>
                        <button onclick="copyToClipboard()" class="btn btn-sm btn-outline-secondary mr-2">
                            üìã Copy Text
                        </button>
                        <button onclick="exportToPDF()" class="btn btn-sm btn-outline-danger">
                            üìÑ Export PDF
                        </button>
                    </div>
                </div>
                
                <div id="report-content" class="mt-3" style="white-space: pre-wrap;">
                    {{ result|safe }}
                    
                    {% if safety_score %}
                    <div class="mt-4">
                        <strong>Estimated Safety Score:</strong> {{ safety_score }}/100
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    <p class="text-muted small text-right">Generated at {{ now|date:"Y-m-d H:i" }}</p>
</div>

<script>
    function copyToClipboard() {
        const reportContent = document.getElementById('report-content').innerText;
        navigator.clipboard.writeText(reportContent).then(() => {
            alert('Report copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    function exportToPDF() {
        // This would typically use a library like jsPDF or html2pdf
        alert('PDF export functionality would be implemented here with a proper PDF library');
        // Example implementation might look like:
        // const element = document.getElementById('report-content');
        // html2pdf().from(element).save('safety-inspection-report.pdf');
    }
</script>
{% endblock %}